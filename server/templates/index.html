<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EZRA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <h1>EZRA</h1>
    <nav>
      <a href="/about">About</a>
      <a href="/terms">Terms of Service</a>
      <a href="/privacy">Privacy Policy</a>
    </nav>
  </header>

  <main>
    <h2>Ephemeral Zero-Knowledge Relay Archive</h2>

    <form id="uploadForm">
      <label for="fileUpload" id="dropZone">
        <input type="file" name="file" id="fileUpload" hidden multiple>
        Drag and drop a file here or click to upload
      </label>
      <button type="submit">Confirm</button>
    </form>

    <div id="uploadOptionsModal" class="modal hidden">
      <div class="modal-content">
        <h3>Upload Settings</h3>
    
        <label>
          Erase after first download:
          <input type="checkbox" id="deleteAfterDownload" checked>
        </label>
        <br>
        <br>
        <label for="expiryDays">Expire after:</label>
        <select id="expiryDays">
          <option value="1">1 day</option>
          <option value="7" selected>7 days</option>
          <option value="14">14 days</option>
          <option value="30">30 days</option>
          <option value="custom">Other…</option>
        </select>
        <input type="number" id="customExpiry" min="1" max="31" placeholder="Enter days (1-31)" class="hidden">

    
    
        <div style="margin-top: 1rem;">
          <button id="confirmUpload">Submit</button>
          <button id="cancelUpload" class="secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!---<p id="responseMsg"></p>-->

    <!---<button id="contactEnterprise">Contact Enterprise Sales</button>-->

    <div id="secretModal" class="modal hidden">
      <div class="modal-content">
        <h3>Secret Key</h3>
        <p id="secretMessage"></p>
        <br>
        <br>
        <button id="copySecret">Copy to Clipboard</button>
        <button id="closeSecretModal" disabled>Close (5)</button>
      </div>
    </div>


    <section id="ezraSummary" class="info-card">
      <h3>What is EZRA?</h3>
      <p><strong>EZRA</strong> (Ephemeral Zero-Knowledge Relay Archive) is a secure file dropbox for those who can’t afford to be tracked.</p>
    
      <div class="info-grid">
        <div><strong>Zero-Knowledge Proof Access:</strong> No usernames, no passwords, no identity storage.</div>
        <div><strong>AES-256-GCM Encrypted Files:</strong> Only you and the recipient can decrypt.</div>
        <div><strong>Ephemeral by Default:</strong> Files auto-delete. No logs. No IPs. No metadata.</div>
        <!--<div><strong>Public Mode:</strong> Anonymous, one-way dropbox with full verifiability.</div>
        <div><strong>Enterprise Mode:</strong> RBAC, optional logging, configurable retention for internal deployments.</div>-->
      </div>
    
      <p class="tagline"><em>Open Source. Verifiable. Trustless by Design.</em></p>
    
      <p><strong>Built for:</strong></p>
      <div class="audience-grid">
        <div>Journalists and whistleblowers</div>
        <div>Incident response and security teams</div>
        <div>Privacy advocates and NGOs</div>
        <div>Anyone who needs plausible deniability and zero data residue</div>
      </div>

      <p class="deploy-tagline"><strong>Deploy in 5 minutes. No accounts. No trust required.</strong></p>
    </section>

    
    <p>Anonymous. Secure. Temporary.</p>
    
    

  </main>
  <script>
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileUpload");
    const dropZone = document.getElementById("dropZone");
    const responseMsg = document.getElementById("responseMsg");
  
    const modal = document.getElementById("uploadOptionsModal");
    const cancelUpload = document.getElementById("cancelUpload");
    const confirmUpload = document.getElementById("confirmUpload");
    const deleteAfterDownload = document.getElementById("deleteAfterDownload");
    let currentSecret = "";
  
    const expirySelect = document.getElementById("expiryDays");
    const customExpiryInput = document.getElementById("customExpiry");

    expirySelect.addEventListener("change", () => {
      if (expirySelect.value === "custom") {
        customExpiryInput.classList.remove("hidden");
        customExpiryInput.required = true;
      } else {
        customExpiryInput.classList.add("hidden");
        customExpiryInput.required = false;
      }
    });
  
    let pendingFiles = [];
  
    // Secret Modal Elements
    const secretModal = document.getElementById("secretModal");
    const secretMessage = document.getElementById("secretMessage");
    const copySecretBtn = document.getElementById("copySecret");
    const closeSecretModalBtn = document.getElementById("closeSecretModal");
  
    // File dialog
    dropZone.addEventListener('click', () => fileInput.click());
  
    // Show selected files
    fileInput.addEventListener('change', function () {
      const files = Array.from(fileInput.files);
      if (files.length > 0) {
        const names = files.map(f => f.name).join(', ');
        dropZone.textContent = `Selected: ${names}`;
      } else {
        dropZone.textContent = 'Drag and drop a file here or click to upload';
      }
    });
  
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
  
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
  
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      fileInput.files = e.dataTransfer.files;
  
      const files = Array.from(fileInput.files);
      const names = files.map(f => f.name).join(', ');
      dropZone.textContent = `Selected: ${names}`;
    });
  
    // Submit shows modal
    uploadForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const files = Array.from(fileInput.files);
      const maxFiles = 5;
  
      if (files.length > maxFiles) {
        alert(`You can only upload up to ${maxFiles} files.`);
        return;
      }
      if (files.length === 0) {
        alert("No files selected.");
        return;
      }
  
      pendingFiles = files;
      modal.classList.remove("hidden");
    });
  
    cancelUpload.addEventListener("click", () => {
      modal.classList.add("hidden");
      pendingFiles = [];
    });

    async function createZipArchive(files) {
      const zip = new JSZip();
      for (const file of files) {
        const content = await file.arrayBuffer();
        zip.file(file.name, content);
      }
      const blob = await zip.generateAsync({ type: "uint8array" });
      return blob;
    }
  

    
    confirmUpload.addEventListener("click", async () => {
      if (pendingFiles.length === 0) return alert("No file selected");

      // Create ZIP archive in browser
      const zipData = await createZipArchive(pendingFiles);

      // Generate AES key and secret
      const aesKey = new Uint8Array(32);
      const secret = new Uint8Array(32);
      window.crypto.getRandomValues(aesKey);
      window.crypto.getRandomValues(secret);

      // Encrypt ZIP using AES-GCM
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const keyObj = await crypto.subtle.importKey('raw', aesKey, { name: 'AES-GCM' }, false, ['encrypt']);
      const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, keyObj, zipData);

      // Encrypted file = nonce + ciphertext
      const encryptedBlob = new Blob([iv, new Uint8Array(ciphertext)], { type: 'application/octet-stream' });

      // FormData
      const formData = new FormData();
      formData.append("file", encryptedBlob, "encrypted.ezra");
      formData.append("secret", btoa(String.fromCharCode(...secret)));

      const selectedValue = expirySelect.value;
      const expireDays = selectedValue === "custom"
        ? parseInt(customExpiryInput.value)
        : parseInt(selectedValue);
      if (isNaN(expireDays) || expireDays < 1 || expireDays > 31) {
        alert("Please enter a valid expiration between 1 and 31 days.");
        return;
      }

      formData.append("expire_days", expireDays);
      formData.append("delete_after_download", deleteAfterDownload.checked);

      try {
        const res = await fetch("/upload", {
          method: "POST",
          body: formData,
        });

        if (res.status === 413) {
          responseMsg.textContent = "File too large. Max size is 50MB.";
          return;
        }

        const json = await res.json();

        // Combine secret + aesKey
        const composite = new Uint8Array(secret.length + aesKey.length);
        composite.set(secret, 0);
        composite.set(aesKey, secret.length);
        const compositeB64 = btoa(String.fromCharCode(...composite));

        showSecretModal(compositeB64);

      } catch (err) {
        console.error(err);
        responseMsg.textContent = "Upload failed. Check the console for more info.";
      } finally {
        modal.classList.add("hidden");
        pendingFiles = [];
      }
    });
  
    // Secret Modal Logic
    function showSecretModal(secret) {
      currentSecret = secret;
      secretMessage.innerHTML = `This is your secret:<br><br><strong>${secret}</strong><br><br>Copy and share it securely. You won't be able to retrieve it again.`;
  
      let countdown = 5;
      closeSecretModalBtn.disabled = true;
      closeSecretModalBtn.textContent = `Close (${countdown})`;
      secretModal.classList.remove("hidden");
  
      const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          closeSecretModalBtn.textContent = `Close (${countdown})`;
        } else {
          clearInterval(timer);
          closeSecretModalBtn.disabled = false;
          closeSecretModalBtn.textContent = "Close";
        }
      }, 1000);
  
      copySecretBtn.onclick = () => {
        const tempInput = document.createElement("textarea");
        tempInput.value = currentSecret; // Clipboard fallback
        document.body.appendChild(tempInput); // Create a temporary input element
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);

        copySecretBtn.textContent = "Copied!";
        setTimeout(() => {
          copySecretBtn.textContent = "Copy to Clipboard";
        }, 2000);
      };
  
      closeSecretModalBtn.onclick = () => {
        secretModal.classList.add("hidden");
        secretMessage.textContent = "";
        currentSecret = "";
        resetUploadUI();

      };
    }

    function resetUploadUI() {
      // Reset file input
      fileInput.value = "";
      dropZone.textContent = "Drag and drop a file here or click to upload";

      // Reset form data
      pendingFiles = [];

      // Also reset form fields just in case
      uploadForm.reset();
    }

  </script>
  
  
</body>
</html>
