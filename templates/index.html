<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EZRA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>EZRA</h1>
    <nav>
      <a href="#">About</a>
      <a href="#">Public Mode</a>
      <a href="#">Enterprise</a>
    </nav>
  </header>

  <main>
    <h2>Ephemeral Zero-Knowledge Relay Archive</h2>
    <p>Anonymous. Secure. Temporary.</p>
    
    <form id="uploadForm">
      <label for="fileUpload" id="dropZone">
        <input type="file" name="file" id="fileUpload" hidden multiple>
        Drag and drop a file here or click to upload
      </label>
      <button type="submit">Confirm</button>
    </form>

    <div id="uploadOptionsModal" class="modal hidden">
      <div class="modal-content">
        <h3>Upload Settings</h3>
    
        <label>
          Erase after first download:
          <input type="checkbox" id="deleteAfterDownload" checked>
        </label>
        <br>
        <br>
        <label for="expiryDays">Expire after (days):</label>
        <select id="expiryDays">
          <!-- options will be dynamically generated -->
        </select>

    
    
        <div style="margin-top: 1rem;">
          <button id="confirmUpload">Submit</button>
          <button id="cancelUpload" class="secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!---<p id="responseMsg"></p>-->

    <!---<button id="contactEnterprise">Contact Enterprise Sales</button>-->

    <div id="secretModal" class="modal hidden">
      <div class="modal-content">
        <h3>Secret Key</h3>
        <p id="secretMessage"></p>
        <br>
        <br>
        <button id="copySecret">Copy to Clipboard</button>
        <button id="closeSecretModal" disabled>Close (5)</button>
      </div>
    </div>

  </main>
  <script>
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileUpload");
    const dropZone = document.getElementById("dropZone");
    const responseMsg = document.getElementById("responseMsg");
  
    const modal = document.getElementById("uploadOptionsModal");
    const cancelUpload = document.getElementById("cancelUpload");
    const confirmUpload = document.getElementById("confirmUpload");
    const deleteAfterDownload = document.getElementById("deleteAfterDownload");
    let currentSecret = "";
  
    const expiryDays = document.getElementById("expiryDays");
    for (let i = 1; i <= 30; i++) {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = i;
      if (i === 7) option.selected = true;
      expiryDays.appendChild(option);
    }
  
    let pendingFiles = [];
  
    // Secret Modal Elements
    const secretModal = document.getElementById("secretModal");
    const secretMessage = document.getElementById("secretMessage");
    const copySecretBtn = document.getElementById("copySecret");
    const closeSecretModalBtn = document.getElementById("closeSecretModal");
  
    // File dialog
    dropZone.addEventListener('click', () => fileInput.click());
  
    // Show selected files
    fileInput.addEventListener('change', function () {
      const files = Array.from(fileInput.files);
      if (files.length > 0) {
        const names = files.map(f => f.name).join(', ');
        dropZone.textContent = `Selected: ${names}`;
      } else {
        dropZone.textContent = 'Drag and drop a file here or click to upload';
      }
    });
  
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
  
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
  
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      fileInput.files = e.dataTransfer.files;
  
      const files = Array.from(fileInput.files);
      const names = files.map(f => f.name).join(', ');
      dropZone.textContent = `Selected: ${names}`;
    });
  
    // Submit shows modal
    uploadForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const files = Array.from(fileInput.files);
      const maxFiles = 5;
  
      if (files.length > maxFiles) {
        alert(`You can only upload up to ${maxFiles} files.`);
        return;
      }
      if (files.length === 0) {
        alert("No files selected.");
        return;
      }
  
      pendingFiles = files;
      modal.classList.remove("hidden");
    });
  
    cancelUpload.addEventListener("click", () => {
      modal.classList.add("hidden");
      pendingFiles = [];
    });
  
    confirmUpload.addEventListener("click", async () => {
      const formData = new FormData();
      pendingFiles.forEach(file => {
        formData.append("file", file);
      });
  
      formData.append("delete_after_download", deleteAfterDownload.checked);
      formData.append("expire_days", expiryDays.value);
  
      try {
        const res = await fetch("/upload", {
          method: "POST",
          body: formData,
        });
  
        if (res.status === 413) {
          responseMsg.textContent = "File too large. Max size is 50MB.";
          return;
        }
  
        const json = await res.json();
        showSecretModal(json.secret);
  
      } catch (err) {
        console.error(err);
        responseMsg.textContent = "Upload failed. Check the console for more info.";
      } finally {
        modal.classList.add("hidden");
        pendingFiles = [];
      }
    });
  
    // Secret Modal Logic
    function showSecretModal(secret) {
      currentSecret = secret;
      secretMessage.innerHTML = `This is your secret:<br><br><strong>${secret}</strong><br><br>Copy and share it securely. You won't be able to retrieve it again.`;
  
      let countdown = 5;
      closeSecretModalBtn.disabled = true;
      closeSecretModalBtn.textContent = `Close (${countdown})`;
      secretModal.classList.remove("hidden");
  
      const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          closeSecretModalBtn.textContent = `Close (${countdown})`;
        } else {
          clearInterval(timer);
          closeSecretModalBtn.disabled = false;
          closeSecretModalBtn.textContent = "Close";
        }
      }, 1000);
  
      copySecretBtn.onclick = () => {
        const tempInput = document.createElement("textarea");
        tempInput.value = currentSecret; // Clipboard fallback
        document.body.appendChild(tempInput); // Create a temporary input element
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);

        copySecretBtn.textContent = "Copied!";
        setTimeout(() => {
          copySecretBtn.textContent = "Copy to Clipboard";
        }, 2000);
      };
  
      closeSecretModalBtn.onclick = () => {
        secretModal.classList.add("hidden");
        secretMessage.textContent = "";
        currentSecret = "";
        resetUploadUI();

      };
    }

    function resetUploadUI() {
      // Reset file input
      fileInput.value = "";
      dropZone.textContent = "Drag and drop a file here or click to upload";

      // Reset form data
      pendingFiles = [];

      // Also reset form fields just in case
      uploadForm.reset();
    }

  </script>
  
  
</body>
</html>
